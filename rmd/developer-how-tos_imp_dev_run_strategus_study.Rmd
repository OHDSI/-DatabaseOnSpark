---
title: '<div>How to Run a Strategus study</div>'
output:
  html_document:
    toc: TRUE
    toc_depth: 3
    toc_float:
      collapsed: FALSE
---

<!--
*
* HOW TO: Import and Export Concept Sets
*
--> 

<!--
*
* Introduction
*
-->

<h2>Introduction</h2>
This document provides a complete example of how to run a Strategus study. 

<!--
*
* Identify CDM data source
*
-->

<h2>Identify or create CDM</h2>
Before starting, identify the datasource to be used as the CDM. 
If you do not have a data source, 
you can create an instance of the Eunomia CDM 
by following the instructions in the 
<a href="./developer-how-tos_ohdsi-on-databricks.html">OHDSI on databricks guide</a> 
in the "Create a test instance of the CDM in Databricks" section.  

<!--
*
* Installation of R and RTools
*
-->

<h2>Installation of R and RTools</h2>
R 4.2.3 and RTools 4.2 are used here. 
These are the versions that were used for testing and validation. 
<p>
R 4.2.3 can be downloaded from 
<a href="https://cran.r-project.org/bin/windows/base/">https://cran.r-project.org/bin/windows/base/</a>. 
<br/>
RTools 4.2 can be downloaded from 
<nobr><a href="https://cran.r-project.org/bin/windows/Rtools/rtools42/rtools.html">https://cran.r-project.org/bin/windows/Rtools/rtools42/rtools.html</a></nobr> 
</p>
<p>
Or the windows installer for each can be directly downloaded here:
<ul>
  <li>
    <a download href="https://www.dropbox.com/scl/fi/2ao0wbi49ic19jcxk8lf0/R-4.2.3-win.exe?rlkey=3qlk90ugzx7q9ym2z3yjqmhl5&dl=1">R 4.2.3</a>
  </li>
  <li>
    <a download href="https://www.dropbox.com/scl/fi/1xi8asmak0u6foi6b5mgc/rtools42-5355-5357.exe?rlkey=r0psxd9e5gv1vk8rkm7pasmad&dl=1">RTools 4.2</a>
  </li>
</ul>
</p>

After downloading the installers perform these steps in order:
<ul>
  <li>Run the R installer executable.</li> 
  <li>Set the LibPath as described below.</li>  
  <li>Then run the RTools installer.</li>
</ul>

<!--
*
* Set LibPaths
*
-->

<h2>Set LibPaths</h2>
Strategus uses the .libPaths() setting shown below. 
In order for libriaries to all be placed in the correct place, 
the default for .libPaths() needs to be set. 
Edit the .Renviron file by running the following.  
<pre class="r">
install.packages("usethis")
library(usethis)
edit_r_environ()
</pre>
Add the following line to your .Renviron file.  
<pre class="r">
R_LIBS_USER="C:/Program Files/R/R-4.2.3/library"
</pre>

<!--
*
* Download Client
*
-->

<h2>Download Client</h2>
To run our Strategus study we will be using a Strategus client called Ergasia 
(named after the Greek god of light work... or so I've been told by ChatGPT). 
Clone the project and check out the desired version as shown below 
(this documentation was created for the v0.0.1 version). 

<pre class="r">
git clone https://github.com/NACHC-CAD/ergasia
cd ergasia
git checkout v0.0.1
</pre>

<p>
  Note that the Ergasia project is somewhat object oriented. 
  Files are best browsed in a tool that supports file browsing a little bit better than RStudio. 
  Here, we will be using Visual Studio Code (VSC) to browse files and RStudio to execute code. 
</p>


<!--
*
* Download Client
*
-->

<h2>Bootstrap</h2>
<p>
  Strategus (an R in general) has requirements for version configuration. 
  Before we can run our study, we need to make sure we have the correct libraries 
  and the correct versions of these libraries installed. 
  This can be done by simply running the Bootstrap.R script found in ./_StartHere/Bootstrap. 
  Open this script in RStudio and execute the entire script (e.g. <Shift><Ctrl><Enter>). 
  This will install the correct version of all of the required R libraries. 
  This script can be run multiple times (install is skipped if the correct version is found). 
  <br/>
  <img src="./img/imp-dev/strategus/01-run-bootstrap.png"/>
</p>

<!--
*
* Resources and Configuration
*
-->

<h2>Resources and Configuration</h2>
<p>
  All of the resources you will normally need to run a study are in the _StartHere folder 
  including all of the configurations you will need to edit or otherwise define. 
</p>
<p>
  To run a study, we will need the following:
  <ul>
    <li>Connection Details for the reporting database (postgres)</li>
    <li>Connection Details for the CDM</li>
    <li>The Strategus study definitions for the studies you are going to run</li>
    <li>A configuration file that pulls everything together</li>
  </ul>
  Details for each of these are given individually below. 
  Test/example versions of each of these are provided except for the CDM database details. 
  There is an example given and you sould be able to create your own based on this example. 
  The example CDM connection details are for a Databricks database and use the keyring pattern defined in the 
  <a href="./developer-how-tos_gen_dev_keyring.html">key ring example</a>.
  Location of these resources is shown below. 
  <br/>
  <img src="./img/imp-dev/strategus/02-resources.png"/>
</p>

<!--
*
* Connection Details: Reporting
*
-->

<h3>Connection Details: Reporting</h3>
<p>
  Connection details for your reporting (postgres) instance can be configured by editing:
  <br/>
  ./_StartHere/ConnectionDetails/Results/ConnectionDetailsForResults.R
  <br/>
  The contents of the existing ConnectionDetailsForCdm.R file are shown below. 
<pre class="pre-scrollable" height="100">
# ---
# 
# ConnectionDetailsFactoryForResults.R
# This script creates the DatabaseConnector connectionDetails objects used for reporting results. 
# Use this code as is or substitute with your own. 
#
# ---

ConnectionDetailsForResults <- {}

ConnectionDetailsForResults$createConnectionDetails <- function() {
  resultsDatabaseConnectionDetails <- DatabaseConnector::createConnectionDetails(
    dbms = "postgresql",
    connectionString = "jdbc:postgresql://localhost:5432/STRAT_RESULTS?user=postgres&password=ohdsi&currentSchema=STRAT_RESULTS",
    pathToDriver = "D:/_YES/databases/postgres/drivers/42.3.3"
  )
  return(resultsDatabaseConnectionDetails)
}

</pre>
</p>

<!--
*
* Connection Details: CDM
*
-->

<h3>Connection Details: CDM</h3>
<p>
  Connection details for your CDM instance can be configured by editing:
  <br/>
  ./_StartHere/ConnectionDetails/CDM/ConnectionDetailsForCdm.R
  <br/>
  Instructions for setting up the keychain used here can be found in the 
  <a href="./developer-how-tos_gen_dev_keyring.html">key ring example</a>.
  The contents of the existing ConnectionDetailsForCdm.R file are shown below. 
<pre class="pre-scrollable" height="100">
# ---
#
# Implementation of ConnectionDetailsForCdm that returns a Databricks connection
# and uses a keyring to store secret information.  
#
# ---

ConnectionDetailsForCdm <- {}

ConnectionDetailsForCdm$get <- function() {
  
  #
  # functions to get databricks token (user will be prompted for keyring password)
  #
  
  getToken <- function () {
    return (
      keyring::backend_file$new()$get(
        service = "production",
        user = "token",
        keyring = "databricks_keyring"
      )
    )
  }
  
  #
  # functions to get url with the token included
  #
  
  getUrl <- function () {
    url <- "jdbc:databricks://nachc-databricks.cloud.databricks.com:443/default;transportMode=http;ssl=1;httpPath=sql/protocolv1/o/3956472157536757/0123-223459-leafy532;AuthMech=3;UseNativeQuery=1;UID=token;PWD="
    return (
      paste(url, getToken(), sep = "")
    )  
  }
  
  connectionDetails <- DatabaseConnector::createConnectionDetails (
    dbms = "spark",
    connectionString = getUrl(),
    pathToDriver="D:\\_YES_2023-05-28\\workspace\\SosExamples\\_COVID\\02-data-diagnostics\\drivers\\databricks\\"
  )

  return(connectionDetails)  
  
}
</pre>
</p>






